<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兒童新樂園-清潔巡檢</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            text-align: center;
            padding-bottom: 80px;
            /* 為了避免被右下角按鈕擋住 */
        }

        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            display: none;
        }

        /* 修改 input 樣式，使其能與 label 在同一行 */
        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        input {
            padding: 10px;
            font-size: 16px;
            width: 60%;
            max-width: 250px;
            margin: 0;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:disabled {
            background-color: #ccc;
        }

        #status {
            margin-top: 20px;
            color: green;
            font-weight: bold;
        }

        /* 設定按鈕樣式 */
        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            padding: 0;
            /* 重設 padding */
        }

        .settings-btn:hover {
            background-color: #5a6268;
        }

        /* 歷史紀錄表格樣式 */
        #historyContainer {
            margin-top: 30px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* 顯示更多按鈕樣式 */
        #loadMoreBtn {
            background-color: #17a2b8;
            margin-top: 15px;
        }

        #loadMoreBtn:hover {
            background-color: #138496;
        }
    </style>
</head>

<body>

    <h2>兒童新樂園-清潔巡檢</h2>

    <!-- 修改：使用 input-group 讓 label 和 input 在同一行 -->
    <div class="input-group">
        <label for="userName">姓名：</label>
        <input type="text" id="userName" placeholder="請點選右下角設定姓名" disabled>
    </div>

    <div>
        <button id="startScanBtn" onclick="startScan()">開啟相機掃描</button>
        <button id="stopScanBtn" onclick="stopScan()" style="display:none; background-color: #dc3545;">關閉相機</button>
    </div>

    <div id="reader"></div>

    <p id="status"></p>

    <!-- 歷史紀錄區塊 -->
    <div id="historyContainer">
        <h3>最近掃描紀錄</h3>
        <table>
            <thead>
                <tr>
                    <th>時間</th>
                    <th>編號</th>
                    <th>樓層</th>
                    <th>地點</th>
                </tr>
            </thead>
            <tbody id="historyBody">
                <!-- 歷史紀錄將插入於此 -->
            </tbody>
        </table>
        <button id="loadMoreBtn" onclick="loadMoreHistory()" style="display: none;">顯示更多</button>
    </div>

    <!-- 設定按鈕 (齒輪圖示) -->
    <button class="settings-btn" onclick="changeName()" title="設定姓名">⚙️</button>

    <script>
        // ==========================================
        // 設定區：請修改這裡
        // ==========================================

        // 1. Google Form 的提交網址 (注意：將 viewform 改為 formResponse)
        const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdN53a49aDc3DBxnsNjuTfpRwTTINKahB2misOc0Myw1UvMiw/formResponse';

        // 2. 表單欄位的 entry ID
        const NAME_ENTRY_ID = 'entry.1432438464';          // 姓名的 ID
        const LOCATION_NAME_ENTRY_ID = 'entry.1212418637'; // 地點名稱的 ID (原 QR Code ID)
        const NUMBER_ENTRY_ID = 'entry.773616430';         // 編號的 ID (新增)
        const FLOOR_ENTRY_ID = 'entry.1031353635';         // 樓層的 ID (新增)

        // 3. 廁所地點資料 (從 wc_no.csv 轉換而來)
        const WC_LOCATIONS = [
            { "no": "14(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "15(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "13(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "12(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "16(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "17(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "18(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "19(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "6(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "8(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "7(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "2(1樓)", "floor": "1F", "name": "" },
            { "no": "1(B1樓)", "floor": "B1", "name": "男廁" },
            { "no": "4(B1樓)", "floor": "B1", "name": "女廁" },
            { "no": "2(B1樓)", "floor": "B1", "name": "親子廁間" },
            { "no": "3(B1樓)", "floor": "B1", "name": "親子廁間" },
            { "no": "3(2樓)", "floor": "2F", "name": "男廁" },
            { "no": "8(2樓)", "floor": "2F", "name": "女廁" },
            { "no": "4(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "5(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "6(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "7(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "9(2樓)", "floor": "2F", "name": "男廁" },
            { "no": "11(2樓)", "floor": "2F", "name": "女廁" },
            { "no": "10(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "3(3樓)", "floor": "3F", "name": "男廁" },
            { "no": "7(3樓)", "floor": "3F", "name": "女廁" },
            { "no": "4(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "5(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "6(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "8(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "11(3樓)", "floor": "3F", "name": "男廁" },
            { "no": "10(3樓)", "floor": "3F", "name": "女廁" },
            { "no": "9(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "12(3樓)", "floor": "3F", "name": "親子廁間" }
        ];

        // ==========================================

        let html5QrCode;
        let displayedHistoryCount = 5; // 預設顯示筆數

        // 頁面載入時讀取 localStorage
        window.onload = function () {
            const savedName = localStorage.getItem('savedUserName');
            if (savedName) {
                document.getElementById('userName').value = savedName;
            }
            renderHistory();
        }

        // 更改姓名功能
        function changeName() {
            const password = prompt("請輸入密碼以更改姓名：");
            if (password === "children") {
                const currentName = localStorage.getItem('savedUserName') || "";
                const newName = prompt("請輸入新的姓名：", currentName);

                if (newName !== null && newName.trim() !== "") {
                    localStorage.setItem('savedUserName', newName.trim());
                    document.getElementById('userName').value = newName.trim();
                    alert("姓名已更新並儲存！");
                }
            } else if (password !== null) {
                alert("密碼錯誤！");
            }
        }

        function startScan() {
            const name = document.getElementById('userName').value;
            if (!name) {
                alert('請先設定姓名！');
                return;
            }

            document.getElementById('reader').style.display = 'block';
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('stopScanBtn').style.display = 'inline-block';
            document.getElementById('status').innerText = "正在啟動相機...";

            html5QrCode = new Html5Qrcode("reader");

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    console.error(err);
                    document.getElementById('status').innerText = "無法啟動相機，請確認權限或使用 HTTPS。";
                });
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    document.getElementById('startScanBtn').style.display = 'inline-block';
                    document.getElementById('stopScanBtn').style.display = 'none';
                    // 修改：不再顯示「已關閉相機」
                    document.getElementById('status').innerText = "";
                }).catch(err => console.error(err));
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            stopScan();

            // 根據掃描到的編號 (decodedText) 查找地點名稱與樓層
            const locationObj = WC_LOCATIONS.find(item => item.no === decodedText);

            if (locationObj) {
                const locationName = locationObj.name;
                const locationFloor = locationObj.floor;

                const displayContent = `${decodedText} (${locationFloor} - ${locationName})`;

                document.getElementById('status').innerText = `掃描成功！內容：${displayContent}`;

                // 更新歷史紀錄 (傳入詳細資訊)
                updateHistory(decodedText, locationFloor, locationName);

                // 提交資料 (傳入 編號、地點名稱、樓層)
                submitToGoogleForm(decodedText, locationName, locationFloor);

                // 彈出視窗
                setTimeout(() => {
                    alert(`掃描成功！\n編號：${decodedText}\n樓層：${locationFloor}\n地點：${locationName}`);
                }, 100);
            } else {
                // 若找不到對應資料，不進行提交
                document.getElementById('status').innerText = `掃描結果：${decodedText} (未知地點)`;
                setTimeout(() => {
                    alert(`掃描到的編號 "${decodedText}" 不在系統資料中，無法提交。`);
                }, 100);
            }
        }

        // 歷史紀錄功能
        function updateHistory(no, floor, name) {
            let history = JSON.parse(localStorage.getItem('scanHistory') || "[]");

            const now = new Date();
            const timeString = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            // 新增到最前面 (儲存詳細欄位)
            history.unshift({ time: timeString, no: no, floor: floor, name: name });

            // 修改：只保留最新的 500 筆
            if (history.length > 500) {
                history = history.slice(0, 500);
            }

            localStorage.setItem('scanHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('scanHistory') || "[]");
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = ""; // 清空表格

            // 根據 displayedHistoryCount 決定顯示多少筆
            const toShow = history.slice(0, displayedHistoryCount);

            toShow.forEach(item => {
                const row = document.createElement('tr');

                const timeCell = document.createElement('td');
                timeCell.innerText = item.time;
                row.appendChild(timeCell);

                // 檢查是否為新格式資料 (有 no 屬性)
                if (item.no !== undefined) {
                    const noCell = document.createElement('td');
                    noCell.innerText = item.no;
                    row.appendChild(noCell);

                    const floorCell = document.createElement('td');
                    floorCell.innerText = item.floor;
                    row.appendChild(floorCell);

                    const nameCell = document.createElement('td');
                    nameCell.innerText = item.name;
                    row.appendChild(nameCell);
                } else {
                    // 舊資料相容：顯示 content，並合併欄位
                    const contentCell = document.createElement('td');
                    contentCell.innerText = item.content || "";
                    contentCell.colSpan = 3;
                    row.appendChild(contentCell);
                }

                tbody.appendChild(row);
            });

            // 控制「顯示更多」按鈕的顯示與否
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (history.length > displayedHistoryCount) {
                loadMoreBtn.style.display = 'inline-block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        // 顯示更多歷史紀錄
        function loadMoreHistory() {
            displayedHistoryCount += 10;
            renderHistory();
        }

        function submitToGoogleForm(qrContent, locationName, locationFloor) {
            const name = document.getElementById('userName').value;

            // 新增檢查：確保姓名已設定
            if (!name || name.trim() === "") {
                alert("請洽管理員進行設定");
                return;
            }

            const iframe = document.createElement('iframe');
            iframe.name = "hidden_iframe";
            iframe.style.display = "none";
            document.body.appendChild(iframe);

            const form = document.createElement('form');
            form.action = GOOGLE_FORM_URL;
            form.method = 'POST';
            form.target = "hidden_iframe";

            // 1. 姓名
            const inputName = document.createElement('input');
            inputName.type = 'hidden';
            inputName.name = NAME_ENTRY_ID;
            inputName.value = name;
            form.appendChild(inputName);

            // 2. 地點名稱
            const inputLocation = document.createElement('input');
            inputLocation.type = 'hidden';
            inputLocation.name = LOCATION_NAME_ENTRY_ID;
            inputLocation.value = locationName;
            form.appendChild(inputLocation);

            // 3. 編號
            const inputNumber = document.createElement('input');
            inputNumber.type = 'hidden';
            inputNumber.name = NUMBER_ENTRY_ID;
            inputNumber.value = qrContent;
            form.appendChild(inputNumber);

            // 4. 樓層 (新增的 ID)
            const inputFloor = document.createElement('input');
            inputFloor.type = 'hidden';
            inputFloor.name = FLOOR_ENTRY_ID;
            inputFloor.value = locationFloor;
            form.appendChild(inputFloor);

            document.body.appendChild(form);

            form.submit();

            document.getElementById('status').innerText = `已送出資料：${name} - ${qrContent} (${locationFloor} - ${locationName})`;

            setTimeout(() => {
                document.body.removeChild(form);
                document.body.removeChild(iframe);
            }, 1000);
        }
    </script>
</body>

</html>
