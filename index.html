<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兒童新樂園-清潔巡檢</title>
    <!-- 引入 html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- 引入 Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        /* 上方控制區塊：左邊姓名，右邊按鈕 */
        .control-panel {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            /* 讓左右高度一致 */
            margin-bottom: 0;
            /* 移除下方 margin，讓紀錄緊接在後 */
            gap: 15px;
        }

        /* 左側姓名區塊 */
        .name-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
        }

        .name-section label {
            font-size: 18px;
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            display: block;
        }

        .name-section input {
            padding: 12px;
            font-size: 18px;
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 10px;
            background-color: white;
            color: #495057;
            text-align: center;
            box-sizing: border-box;
        }

        /* 右側按鈕區塊 */
        .scan-section {
            flex: 0 0 auto;
        }

        /* 大顆方形掃描按鈕 */
        #startScanBtn {
            width: 130px;
            /* 稍微縮小寬度以配合高度減少 */
            height: 130px;
            /* 減少高度 */
            border-radius: 25px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 0;
        }

        #startScanBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0, 123, 255, 0.4);
        }

        #startScanBtn:active {
            transform: scale(0.96);
        }

        #startScanBtn svg {
            width: 70px;
            /* 稍微縮小圖示 */
            height: 70px;
            fill: white;
            margin: 0;
            /* 移除 margin */
        }

        /* 隱藏文字 */
        #startScanBtn span {
            display: none;
        }

        #stopScanBtn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
            display: none;
        }

        #reader {
            width: 100%;
            margin: 20px auto;
            display: none;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #status {
            margin-top: 10px;
            margin-bottom: 10px;
            color: #28a745;
            font-weight: bold;
            font-size: 1em;
            min-height: 20px;
        }

        /* 設定按鈕樣式 */
        .settings-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            padding: 0;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .settings-btn:hover {
            transform: rotate(30deg) scale(1.1);
        }

        /* 歷史紀錄表格樣式 */
        #historyContainer {
            margin-top: 10px;
            /* 減少與上方的間距 */
            width: 100%;
        }

        h3 {
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
            text-align: left;
            font-size: 1.1em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            table-layout: fixed;
        }

        th,
        td {
            padding: 8px 4px;
            /* 再稍微減少 padding */
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            /* 稍微縮小字體以容納更多內容 */
            word-break: break-word;
        }

        /* 設定欄位寬度 */
        th:nth-child(1),
        td:nth-child(1) {
            width: 32%;
        }

        /* 時間 */
        th:nth-child(2),
        td:nth-child(2) {
            width: 20%;
        }

        /* 編號 */
        th:nth-child(3),
        td:nth-child(3) {
            width: 18%;
        }

        /* 樓層 */
        th:nth-child(4),
        td:nth-child(4) {
            width: 30%;
        }

        /* 地點 */

        th {
            background-color: #f8f9fa;
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* 顯示更多按鈕樣式 */
        #loadMoreBtn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #loadMoreBtn:hover {
            background-color: #138496;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>兒童新樂園-清潔巡檢</h2>

        <!-- 控制面板：左姓名，右按鈕 -->
        <div class="control-panel">
            <!-- 左側：姓名輸入 -->
            <div class="name-section">
                <label for="userName">姓名</label>
                <input type="text" id="userName" placeholder="點選右下角設定" disabled>
            </div>

            <!-- 右側：掃描按鈕 -->
            <div class="scan-section">
                <button id="startScanBtn" onclick="startScan()" title="開啟相機掃描">
                    <!-- 相機 SVG 圖示 -->
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 關閉相機按鈕 (獨立出來，掃描時才顯示) -->
        <button id="stopScanBtn" onclick="stopScan()">關閉相機</button>

        <div id="reader"></div>

        <p id="status"></p>

        <!-- 歷史紀錄區塊 -->
        <div id="historyContainer">
            <h3>紀錄</h3>
            <table>
                <thead>
                    <tr>
                        <th>時間</th>
                        <th>編號</th>
                        <th>樓層</th>
                        <th>地點</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- 歷史紀錄將插入於此 -->
                </tbody>
            </table>
            <button id="loadMoreBtn" onclick="loadMoreHistory()" style="display: none;">顯示更多</button>
        </div>
    </div>

    <!-- 設定按鈕 (齒輪圖示) -->
    <button class="settings-btn" onclick="changeName()" title="設定姓名">⚙️</button>

    <script>
        // ==========================================
        // 設定區：請修改這裡 (Supabase 設定)
        // ==========================================

        // 請在此填入您的 Supabase URL 和 Anon Key
        const SUPABASE_URL = 'https://fjvklwfoapytbbebpobp.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_WmoT6IVZ5QhLTLevmm2wWA_l521JsV_';

        // 資料表名稱 (請確保 Supabase 中有此資料表)
        // 建議欄位結構:
        // id (int8, primary key)
        // user_name (text)
        // location_no (text)
        // location_name (text)
        // floor (text)
        // created_at (timestamptz, default: now())
        const TABLE_NAME = 'clean_wc';

        // 初始化 Supabase 客戶端
        let supabaseClient = null;
        try {
            if (typeof supabase !== 'undefined') {
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                console.error("Supabase SDK 未正確載入");
            }
        } catch (e) {
            console.error("Supabase 初始化失敗:", e);
        }

        // 3. 廁所地點資料 (從 wc_no.csv 轉換而來)
        const WC_LOCATIONS = [
            { "no": "14(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "15(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "13(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "12(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "16(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "17(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "18(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "19(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "6(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "8(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "7(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "2(1樓)", "floor": "1F", "name": "淨下設施" },
            { "no": "1(B1樓)", "floor": "B1", "name": "男廁" },
            { "no": "4(B1樓)", "floor": "B1", "name": "女廁" },
            { "no": "2(B1樓)", "floor": "B1", "name": "親子廁間" },
            { "no": "3(B1樓)", "floor": "B1", "name": "親子廁間" },
            { "no": "3(2樓)", "floor": "2F", "name": "男廁" },
            { "no": "8(2樓)", "floor": "2F", "name": "女廁" },
            { "no": "4(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "5(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "6(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "7(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "9(2樓)", "floor": "2F", "name": "男廁" },
            { "no": "11(2樓)", "floor": "2F", "name": "女廁" },
            { "no": "10(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "3(3樓)", "floor": "3F", "name": "男廁" },
            { "no": "7(3樓)", "floor": "3F", "name": "女廁" },
            { "no": "4(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "5(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "6(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "8(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "11(3樓)", "floor": "3F", "name": "男廁" },
            { "no": "10(3樓)", "floor": "3F", "name": "女廁" },
            { "no": "9(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "12(3樓)", "floor": "3F", "name": "親子廁間" }
        ];

        // ==========================================

        let html5QrCode;
        let displayedHistoryCount = 5; // 預設顯示筆數

        // 頁面載入時讀取 localStorage
        window.onload = function () {
            const savedName = localStorage.getItem('savedUserName');
            if (savedName) {
                document.getElementById('userName').value = savedName;
            }
            renderHistory();
        }

        // 更改姓名功能
        function changeName() {
            const password = prompt("請輸入密碼以更改姓名：");
            if (password === "0000") {
                const currentName = localStorage.getItem('savedUserName') || "";
                // 根據是否已有姓名，顯示不同的提示文字
                const promptMsg = currentName ? "請輸入新的姓名 (留空並確認可刪除所有資料)：" : "請輸入姓名：";
                const newName = prompt(promptMsg, currentName);

                if (newName !== null) {
                    const trimmedNewName = newName.trim();

                    if (trimmedNewName !== "") {
                        // 輸入了有效姓名 -> 更新並儲存
                        localStorage.setItem('savedUserName', trimmedNewName);
                        document.getElementById('userName').value = trimmedNewName;
                        alert("姓名已更新並儲存！");
                    } else {
                        // 輸入空白
                        if (currentName !== "") {
                            // 只有在「原本已有姓名」的情況下，才執行清除資料的邏輯
                            if (confirm("您輸入了空白姓名，是否要刪除姓名與所有歷史紀錄？")) {
                                localStorage.removeItem('savedUserName');
                                localStorage.removeItem('scanHistory');
                                document.getElementById('userName').value = "";
                                renderHistory(); // 重新渲染表格（會變空）
                                alert("資料已全部清除！");
                            }
                        } else {
                            // 首次使用（或原本無姓名）且輸入空白 -> 提示需輸入
                            alert("請輸入有效姓名！");
                        }
                    }
                }
            } else if (password !== null) {
                alert("密碼錯誤！");
            }
        }

        function startScan() {
            const name = document.getElementById('userName').value;
            if (!name) {
                alert('請先設定姓名！');
                return;
            }

            // 檢查 Supabase 設定
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                alert('請先在程式碼中設定 Supabase URL 和 Anon Key！');
                return;
            }

            document.getElementById('reader').style.display = 'block';
            document.getElementById('stopScanBtn').style.display = 'block';
            document.getElementById('status').innerText = "正在啟動相機...";

            html5QrCode = new Html5Qrcode("reader");

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    console.error(err);
                    document.getElementById('status').innerText = "無法啟動相機，請確認權限或使用 HTTPS。";
                });
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    document.getElementById('stopScanBtn').style.display = 'none';
                    document.getElementById('status').innerText = "";
                }).catch(err => console.error(err));
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            stopScan();

            // 根據掃描到的編號 (decodedText) 查找地點名稱與樓層
            const locationObj = WC_LOCATIONS.find(item => item.no === decodedText);

            if (locationObj) {
                const locationName = locationObj.name;
                const locationFloor = locationObj.floor;

                const displayContent = `${decodedText} (${locationFloor} - ${locationName})`;

                document.getElementById('status').innerText = `掃描成功！內容：${displayContent}`;

                // 更新歷史紀錄 (傳入詳細資訊)
                updateHistory(decodedText, locationFloor, locationName);

                // 提交資料到 Supabase
                submitToSupabase(decodedText, locationName, locationFloor);

                // 彈出視窗
                setTimeout(() => {
                    alert(`掃描成功！\n編號：${decodedText}\n樓層：${locationFloor}\n地點：${locationName}`);
                }, 100);
            } else {
                // 若找不到對應資料，不進行提交
                document.getElementById('status').innerText = `掃描結果：${decodedText} (未知地點)`;
                setTimeout(() => {
                    alert(`掃描到的編號 "${decodedText}" 不在系統資料中，無法提交。`);
                }, 100);
            }
        }

        // 歷史紀錄功能
        function updateHistory(no, floor, name) {
            let history = JSON.parse(localStorage.getItem('scanHistory') || "[]");

            const now = new Date();
            // 修改時間格式，加入秒數
            const timeString = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

            // 新增到最前面 (儲存詳細欄位)
            history.unshift({ time: timeString, no: no, floor: floor, name: name });

            // 修改：只保留最新的 500 筆
            if (history.length > 500) {
                history = history.slice(0, 500);
            }

            localStorage.setItem('scanHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('scanHistory') || "[]");
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = ""; // 清空表格

            // 根據 displayedHistoryCount 決定顯示多少筆
            const toShow = history.slice(0, displayedHistoryCount);

            toShow.forEach(item => {
                const row = document.createElement('tr');

                const timeCell = document.createElement('td');
                timeCell.innerText = item.time;
                row.appendChild(timeCell);

                // 檢查是否為新格式資料 (有 no 屬性)
                if (item.no !== undefined) {
                    const noCell = document.createElement('td');
                    noCell.innerText = item.no;
                    row.appendChild(noCell);

                    const floorCell = document.createElement('td');
                    floorCell.innerText = item.floor;
                    row.appendChild(floorCell);

                    const nameCell = document.createElement('td');
                    nameCell.innerText = item.name;
                    row.appendChild(nameCell);
                } else {
                    // 舊資料相容：顯示 content，並合併欄位
                    const contentCell = document.createElement('td');
                    contentCell.innerText = item.content || "";
                    contentCell.colSpan = 3;
                    row.appendChild(contentCell);
                }

                tbody.appendChild(row);
            });

            // 控制「顯示更多」按鈕的顯示與否
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (history.length > displayedHistoryCount) {
                loadMoreBtn.style.display = 'inline-block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        // 顯示更多歷史紀錄
        function loadMoreHistory() {
            displayedHistoryCount += 10;
            renderHistory();
        }

        // 提交資料到 Supabase
        async function submitToSupabase(qrContent, locationName, locationFloor) {
            const who = document.getElementById('userName').value;

            // 新增檢查：確保姓名已設定
            if (!who || who.trim() === "") {
                alert("請洽管理員進行設定");
                return;
            }

            if (!supabaseClient) {
                console.error("Supabase Client 未初始化");
                document.getElementById('status').innerText = "系統錯誤：資料庫連線失敗";
                return;
            }

            document.getElementById('status').innerText = "正在上傳資料...";

            try {
                // 準備要寫入的資料物件
                const record = {
                    who: who,
                    wc_id: qrContent,
                    wc_type: locationName,
                    floor: locationFloor,
                    // created_at 會由資料庫自動產生，除非需要指定特定時間
                };

                const { data, error } = await supabaseClient
                    .from(TABLE_NAME)
                    .insert([record])
                    .select();

                if (error) {
                    throw error;
                }

                console.log("Supabase Insert Success:", data);
                document.getElementById('status').innerText = `資料上傳成功：${who} - ${qrContent}`;

            } catch (err) {
                console.error('Supabase Error:', err);
                document.getElementById('status').innerText = `上傳失敗：${err.message || err.error_description}`;
                // 這裡可以選擇是否要彈出 alert，避免干擾使用者連續掃描，但為了明確告知錯誤，先保留
                // alert(`上傳資料庫失敗：${err.message}`);
            }
        }
    </script>
</body>

</html>
