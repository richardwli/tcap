<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兒童新樂園-清潔巡檢</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        /* 上方控制區塊：左邊姓名，右邊按鈕 */
        .control-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        /* 左側姓名區塊 */
        .name-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            height: 130px;
            /* 與按鈕高度一致 */
        }

        .name-section label {
            font-size: 18px;
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            display: block;
        }

        .name-section input {
            padding: 12px;
            font-size: 18px;
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 10px;
            background-color: white;
            color: #495057;
            text-align: center;
            box-sizing: border-box;
            /* 確保 padding 不會撐大寬度 */
        }

        /* 右側按鈕區塊 */
        .scan-section {
            flex: 0 0 auto;
            /* 不縮放 */
        }

        /* 大顆方形掃描按鈕 */
        #startScanBtn {
            width: 160px;
            height: 160px;
            border-radius: 25px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 0;
            /* 移除 margin */
        }

        #startScanBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0, 123, 255, 0.4);
        }

        #startScanBtn:active {
            transform: scale(0.96);
        }

        #startScanBtn svg {
            width: 80px;
            height: 80px;
            fill: white;
            margin-bottom: 10px;
        }

        #startScanBtn span {
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        #stopScanBtn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
            display: none;
            /* 預設隱藏 */
        }

        #reader {
            width: 100%;
            margin: 20px auto;
            display: none;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #status {
            margin-top: 15px;
            color: #28a745;
            font-weight: bold;
            font-size: 1.1em;
            min-height: 24px;
        }

        /* 設定按鈕樣式 */
        .settings-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            padding: 0;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .settings-btn:hover {
            transform: rotate(30deg) scale(1.1);
        }

        /* 歷史紀錄表格樣式 */
        #historyContainer {
            margin-top: 30px;
            width: 100%;
        }

        h3 {
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            text-align: left;
            /* 標題靠左 */
            font-size: 1.2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            /* box-shadow: 0 2px 8px rgba(0,0,0,0.05); */
            /* 移除陰影以減少邊距感 */
            table-layout: fixed;
            /* 強制固定寬度 */
        }

        th,
        td {
            padding: 10px 5px;
            /* 減少左右 padding */
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            width: 25%;
            /* 四個欄位平均寬度 */
            word-break: break-word;
            /* 防止文字過長撐開 */
        }

        th {
            background-color: #f8f9fa;
            color: #666;
            font-weight: 600;
            font-size: 15px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* 顯示更多按鈕樣式 */
        #loadMoreBtn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #loadMoreBtn:hover {
            background-color: #138496;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>兒童新樂園-清潔巡檢</h2>

        <!-- 控制面板：左姓名，右按鈕 -->
        <div class="control-panel">
            <!-- 左側：姓名輸入 -->
            <div class="name-section">
                <label for="userName">姓名</label>
                <input type="text" id="userName" placeholder="點選右下角設定" disabled>
            </div>

            <!-- 右側：掃描按鈕 -->
            <div class="scan-section">
                <button id="startScanBtn" onclick="startScan()" title="開啟相機掃描">
                    <!-- 相機 SVG 圖示 -->
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
                    </svg>
                    <span>掃描</span>
                </button>
            </div>
        </div>

        <!-- 關閉相機按鈕 (獨立出來，掃描時才顯示) -->
        <button id="stopScanBtn" onclick="stopScan()">關閉相機</button>

        <div id="reader"></div>

        <p id="status"></p>

        <!-- 歷史紀錄區塊 -->
        <div id="historyContainer">
            <h3>紀錄</h3>
            <table>
                <thead>
                    <tr>
                        <th>時間</th>
                        <th>編號</th>
                        <th>樓層</th>
                        <th>地點</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- 歷史紀錄將插入於此 -->
                </tbody>
            </table>
            <button id="loadMoreBtn" onclick="loadMoreHistory()" style="display: none;">顯示更多</button>
        </div>
    </div>

    <!-- 設定按鈕 (齒輪圖示) -->
    <button class="settings-btn" onclick="changeName()" title="設定姓名">⚙️</button>

    <script>
        // ==========================================
        // 設定區：請修改這裡
        // ==========================================

        // 1. Google Form 的提交網址 (注意：將 viewform 改為 formResponse)
        const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdN53a49aDc3DBxnsNjuTfpRwTTINKahB2misOc0Myw1UvMiw/formResponse';

        // 2. 表單欄位的 entry ID
        const NAME_ENTRY_ID = 'entry.1432438464';          // 姓名的 ID
        const LOCATION_NAME_ENTRY_ID = 'entry.1212418637'; // 地點名稱的 ID (原 QR Code ID)
        const NUMBER_ENTRY_ID = 'entry.773616430';         // 編號的 ID (新增)
        const FLOOR_ENTRY_ID = 'entry.1031353635';         // 樓層的 ID (新增)

        // 3. 廁所地點資料 (從 wc_no.csv 轉換而來)
        const WC_LOCATIONS = [
            { "no": "14(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "15(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "13(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "12(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "16(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "17(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "18(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "19(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "6(1樓)", "floor": "1F", "name": "男廁" },
            { "no": "8(1樓)", "floor": "1F", "name": "女廁" },
            { "no": "7(1樓)", "floor": "1F", "name": "親子廁間" },
            { "no": "2(1樓)", "floor": "1F", "name": "" },
            { "no": "1(B1樓)", "floor": "B1", "name": "男廁" },
            { "no": "4(B1樓)", "floor": "B1", "name": "女廁" },
            { "no": "2(B1樓)", "floor": "B1", "name": "親子廁間" },
            { "no": "3(B1樓)", "floor": "B1", "name": "親子廁間" },
            { "no": "3(2樓)", "floor": "2F", "name": "男廁" },
            { "no": "8(2樓)", "floor": "2F", "name": "女廁" },
            { "no": "4(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "5(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "6(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "7(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "9(2樓)", "floor": "2F", "name": "男廁" },
            { "no": "11(2樓)", "floor": "2F", "name": "女廁" },
            { "no": "10(2樓)", "floor": "2F", "name": "親子廁間" },
            { "no": "3(3樓)", "floor": "3F", "name": "男廁" },
            { "no": "7(3樓)", "floor": "3F", "name": "女廁" },
            { "no": "4(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "5(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "6(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "8(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "11(3樓)", "floor": "3F", "name": "男廁" },
            { "no": "10(3樓)", "floor": "3F", "name": "女廁" },
            { "no": "9(3樓)", "floor": "3F", "name": "親子廁間" },
            { "no": "12(3樓)", "floor": "3F", "name": "親子廁間" }
        ];

        // ==========================================

        let html5QrCode;
        let displayedHistoryCount = 5; // 預設顯示筆數

        // 頁面載入時讀取 localStorage
        window.onload = function () {
            const savedName = localStorage.getItem('savedUserName');
            if (savedName) {
                document.getElementById('userName').value = savedName;
            }
            renderHistory();
        }

        // 更改姓名功能
        function changeName() {
            const password = prompt("請輸入密碼以更改姓名：");
            if (password === "children") {
                const currentName = localStorage.getItem('savedUserName') || "";
                const newName = prompt("請輸入新的姓名：", currentName);

                if (newName !== null && newName.trim() !== "") {
                    localStorage.setItem('savedUserName', newName.trim());
                    document.getElementById('userName').value = newName.trim();
                    alert("姓名已更新並儲存！");
                }
            } else if (password !== null) {
                alert("密碼錯誤！");
            }
        }

        function startScan() {
            const name = document.getElementById('userName').value;
            if (!name) {
                alert('請先設定姓名！');
                return;
            }

            document.getElementById('reader').style.display = 'block';
            // document.getElementById('startScanBtn').style.display = 'none'; // 掃描時不隱藏按鈕，保持版面
            document.getElementById('stopScanBtn').style.display = 'block';
            document.getElementById('status').innerText = "正在啟動相機...";

            html5QrCode = new Html5Qrcode("reader");

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    console.error(err);
                    document.getElementById('status').innerText = "無法啟動相機，請確認權限或使用 HTTPS。";
                });
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    // document.getElementById('startScanBtn').style.display = 'flex';
                    document.getElementById('stopScanBtn').style.display = 'none';
                    // 修改：不再顯示「已關閉相機」
                    document.getElementById('status').innerText = "";
                }).catch(err => console.error(err));
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            stopScan();

            // 根據掃描到的編號 (decodedText) 查找地點名稱與樓層
            const locationObj = WC_LOCATIONS.find(item => item.no === decodedText);

            if (locationObj) {
                const locationName = locationObj.name;
                const locationFloor = locationObj.floor;

                const displayContent = `${decodedText} (${locationFloor} - ${locationName})`;

                document.getElementById('status').innerText = `掃描成功！內容：${displayContent}`;

                // 更新歷史紀錄 (傳入詳細資訊)
                updateHistory(decodedText, locationFloor, locationName);

                // 提交資料 (傳入 編號、地點名稱、樓層)
                submitToGoogleForm(decodedText, locationName, locationFloor);

                // 彈出視窗
                setTimeout(() => {
                    alert(`掃描成功！\n編號：${decodedText}\n樓層：${locationFloor}\n地點：${locationName}`);
                }, 100);
            } else {
                // 若找不到對應資料，不進行提交
                document.getElementById('status').innerText = `掃描結果：${decodedText} (未知地點)`;
                setTimeout(() => {
                    alert(`掃描到的編號 "${decodedText}" 不在系統資料中，無法提交。`);
                }, 100);
            }
        }

        // 歷史紀錄功能
        function updateHistory(no, floor, name) {
            let history = JSON.parse(localStorage.getItem('scanHistory') || "[]");

            const now = new Date();
            const timeString = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            // 新增到最前面 (儲存詳細欄位)
            history.unshift({ time: timeString, no: no, floor: floor, name: name });

            // 修改：只保留最新的 500 筆
            if (history.length > 500) {
                history = history.slice(0, 500);
            }

            localStorage.setItem('scanHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('scanHistory') || "[]");
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = ""; // 清空表格

            // 根據 displayedHistoryCount 決定顯示多少筆
            const toShow = history.slice(0, displayedHistoryCount);

            toShow.forEach(item => {
                const row = document.createElement('tr');

                const timeCell = document.createElement('td');
                timeCell.innerText = item.time;
                row.appendChild(timeCell);

                // 檢查是否為新格式資料 (有 no 屬性)
                if (item.no !== undefined) {
                    const noCell = document.createElement('td');
                    noCell.innerText = item.no;
                    row.appendChild(noCell);

                    const floorCell = document.createElement('td');
                    floorCell.innerText = item.floor;
                    row.appendChild(floorCell);

                    const nameCell = document.createElement('td');
                    nameCell.innerText = item.name;
                    row.appendChild(nameCell);
                } else {
                    // 舊資料相容：顯示 content，並合併欄位
                    const contentCell = document.createElement('td');
                    contentCell.innerText = item.content || "";
                    contentCell.colSpan = 3;
                    row.appendChild(contentCell);
                }

                tbody.appendChild(row);
            });

            // 控制「顯示更多」按鈕的顯示與否
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (history.length > displayedHistoryCount) {
                loadMoreBtn.style.display = 'inline-block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        // 顯示更多歷史紀錄
        function loadMoreHistory() {
            displayedHistoryCount += 10;
            renderHistory();
        }

        function submitToGoogleForm(qrContent, locationName, locationFloor) {
            const name = document.getElementById('userName').value;

            // 新增檢查：確保姓名已設定
            if (!name || name.trim() === "") {
                alert("請洽管理員進行設定");
                return;
            }

            const iframe = document.createElement('iframe');
            iframe.name = "hidden_iframe";
            iframe.style.display = "none";
            document.body.appendChild(iframe);

            const form = document.createElement('form');
            form.action = GOOGLE_FORM_URL;
            form.method = 'POST';
            form.target = "hidden_iframe";

            // 1. 姓名
            const inputName = document.createElement('input');
            inputName.type = 'hidden';
            inputName.name = NAME_ENTRY_ID;
            inputName.value = name;
            form.appendChild(inputName);

            // 2. 地點名稱
            const inputLocation = document.createElement('input');
            inputLocation.type = 'hidden';
            inputLocation.name = LOCATION_NAME_ENTRY_ID;
            inputLocation.value = locationName;
            form.appendChild(inputLocation);

            // 3. 編號
            const inputNumber = document.createElement('input');
            inputNumber.type = 'hidden';
            inputNumber.name = NUMBER_ENTRY_ID;
            inputNumber.value = qrContent;
            form.appendChild(inputNumber);

            // 4. 樓層 (新增的 ID)
            const inputFloor = document.createElement('input');
            inputFloor.type = 'hidden';
            inputFloor.name = FLOOR_ENTRY_ID;
            inputFloor.value = locationFloor;
            form.appendChild(inputFloor);

            document.body.appendChild(form);

            form.submit();

            document.getElementById('status').innerText = `已送出資料：${name} - ${qrContent} (${locationFloor} - ${locationName})`;

            setTimeout(() => {
                document.body.removeChild(form);
                document.body.removeChild(iframe);
            }, 1000);
        }
    </script>
</body>

</html>
